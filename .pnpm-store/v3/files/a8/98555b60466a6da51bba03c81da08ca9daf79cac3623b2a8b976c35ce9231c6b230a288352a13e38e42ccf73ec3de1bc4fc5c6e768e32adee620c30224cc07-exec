import g from"path";import{fileURLToPath as _,pathToFileURL as R}from"url";import{installSourceMapSupport as F,compareNodeVersion as w,resolveTsPath as U,transform as P,transformDynamicImport as l}from"@esbuild-kit/core-utils";import{parseTsconfig as D,getTsconfig as I,createFilesMatcher as W,createPathsMatcher as v}from"get-tsconfig";import T from"fs";const p=new Map;async function A(t){if(p.has(t))return p.get(t);if(!await T.promises.access(t).then(()=>!0,()=>!1)){p.set(t,void 0);return}const o=await T.promises.readFile(t,"utf8");try{const a=JSON.parse(o);return p.set(t,a),a}catch{throw new Error(`Error parsing: ${t}`)}}async function J(t){let s=new URL("package.json",t);for(;!s.pathname.endsWith("/node_modules/package.json");){const o=_(s),a=await A(o);if(a)return a;const r=s;if(s=new URL("../package.json",s),s.pathname===r.pathname)break}}async function M(t){var s;const o=await J(t);return(s=o==null?void 0:o.type)!=null?s:"commonjs"}const f=F(),h=process.env.ESBK_TSCONFIG_PATH?{path:g.resolve(process.env.ESBK_TSCONFIG_PATH),config:D(process.env.ESBK_TSCONFIG_PATH)}:I(),k=h&&W(h),N=h&&v(h),y="file://",d=/\.([cm]?ts|[tj]sx)$/,L=t=>{const s=g.extname(t);if(s===".json")return"json";if(s===".mjs"||s===".mts")return"module";if(s===".cjs"||s===".cts")return"commonjs"},S=t=>{const s=L(t);if(s)return s;if(d.test(t))return M(t)},C=[".js",".json",".ts",".tsx",".jsx"];async function E(t,s,o){let a;for(const r of C)try{return await u(t+r,s,o,!0)}catch(n){if(a===void 0){const{message:c}=n;n.message=n.message.replace(`${r}'`,"'"),n.stack=n.stack.replace(c,n.message),a=n}}throw a}async function O(t,s,o){const a=t.endsWith("/"),r=a?"index":"/index";try{return await E(t+r,s,o)}catch(n){if(!a)try{return await E(t,s,o)}catch{}const{message:c}=n;throw n.message=n.message.replace(`${r.replace("/",g.sep)}'`,"'"),n.stack=n.stack.replace(c,n.message),n}}const K=/^\.{0,2}\//,x=w([14,13,1])>=0||w([12,20,0])>=0,u=async function(t,s,o,a){var r;if(!x&&t.startsWith("node:")&&(t=t.slice(5)),t.endsWith("/"))return await O(t,s,o);const n=t.startsWith(y)||K.test(t);if(N&&!n&&!((r=s.parentURL)!=null&&r.includes("/node_modules/"))){const e=N(t);for(const i of e)try{return await u(R(i).toString(),s,o)}catch{}}if(d.test(s.parentURL)){const e=U(t);if(e)try{return await u(e,s,o,!0)}catch(i){const{code:m}=i;if(m!=="ERR_MODULE_NOT_FOUND"&&m!=="ERR_PACKAGE_PATH_NOT_EXPORTED")throw i}}let c;try{c=await o(t,s,o)}catch(e){if(e instanceof Error&&!a){const{code:i}=e;if(i==="ERR_UNSUPPORTED_DIR_IMPORT")try{return await O(t,s,o)}catch(m){if(m.code!=="ERR_PACKAGE_IMPORT_NOT_DEFINED")throw m}if(i==="ERR_MODULE_NOT_FOUND")try{return await E(t,s,o)}catch{}}throw e}return!c.format&&c.url.startsWith(y)&&(c.format=await S(c.url)),c},b=async function(t,s,o){var a;process.send&&process.send({type:"dependency",path:t}),t.endsWith(".json")&&(s.importAssertions||(s.importAssertions={}),s.importAssertions.type="json");const r=await o(t,s,o);if(!r.source)return r;const n=t.startsWith("file://")?_(t):t,c=r.source.toString();if(r.format==="json"||d.test(t)){const e=await P(c,n,{tsconfigRaw:(a=k)==null?void 0:a(n)});return{format:"module",source:f(e,t)}}if(r.format==="module"){const e=l(n,c);e&&(r.source=f(e,t))}return r},G=async function(t,s,o){if(t.endsWith(".json"))return{format:"module"};try{return await o(t,s,o)}catch(a){if(a.code==="ERR_UNKNOWN_FILE_EXTENSION"&&t.startsWith(y)){const r=await S(t);if(r)return{format:r}}throw a}},H=async function(t,s,o){var a;const{url:r}=s,n=r.startsWith("file://")?_(r):r;if(process.send&&process.send({type:"dependency",path:r}),r.endsWith(".json")||d.test(r)){const e=await P(t.toString(),n,{tsconfigRaw:(a=k)==null?void 0:a(n)});return{source:f(e,r)}}const c=await o(t,s,o);if(s.format==="module"){const e=l(n,c.source.toString());e&&(c.source=f(e,r))}return c},j=w([16,12,0])<0,$=j?G:void 0,B=j?H:void 0;export{$ as getFormat,b as load,u as resolve,B as transformSource};
